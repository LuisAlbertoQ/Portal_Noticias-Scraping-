{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2><i class="fas fa-chart-line"></i> Mis An√°lisis de Noticias con IA</h2>
    
    <!-- Debug Real -->
    <div class="alert alert-info">
        <strong>üîç Debug:</strong> Usuario: {{ user.username }} | 
        An√°lisis completados: {{ noticias_analizadas_ids|length }}
    </div>
    
    <!-- Filtros -->
    <div class="btn-group mb-3">
        <a href="?filtro=todas" class="btn btn-outline-primary {% if filtro_actual == 'todas' %}active{% endif %}">
            Todas ({{ noticias|length }})
        </a>
        <a href="?filtro=con_analisis" class="btn btn-outline-primary {% if filtro_actual == 'con_analisis' %}active{% endif %}">
            Con An√°lisis ({{ noticias_analizadas_ids|length }})
        </a>
        <a href="?filtro=sin_analisis" class="btn btn-outline-primary {% if filtro_actual == 'sin_analisis' %}active{% endif %}">
            Sin Analizar
        </a>
    </div>
    
    <!-- Lista de noticias -->
    <div class="row">
        {% for noticia in noticias %}
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    
                    <!-- DEBUG EXTREMO (eliminar despu√©s) -->
                    <div class="small mb-2" style="font-family: monospace; background: #ffe6e6; padding: 5px;">
                        Noticia ID: {{ noticia.id }} | 
                        {% if noticia.id in noticias_analizadas_ids %}
                            <span style="color: green; font-weight: bold;">‚úÖ ANALIZADA</span>
                        {% else %}
                            <span style="color: red; font-weight: bold;">‚ùå NO analizada</span>
                        {% endif %}
                    </div>
                    
                    <h5 class="card-title">{{ noticia.titulo|truncatechars:80 }}</h5>
                    <p class="card-text">
                        <small class="text-muted">
                            {{ noticia.origen }} - {{ noticia.fecha|date:"d/m/Y" }}
                        </small>
                    </p>
                    
                    <!-- BOT√ìN QUE CAMBIA DE COLOR - L√ìGICA DIRECTA -->
                    <div class="mt-3">
                        {% comment %}
                        ** FORMA DIRECTA SIN TEMPLATE TAG **
                        Buscamos en el diccionario usando .items y comparamos IDs
                        {% endcomment %}
                        {% with noticia_id=noticia.id %}
                        {% with analisis_obj=analisis_usuario.get noticia.id %}
                            {% if analisis_obj %}
                                <!-- ‚úÖ TIENE AN√ÅLISIS - BOT√ìN VERDE -->
                                {% if analisis_obj.estado == 'completado' %}
                                    <a href="{% url 'analisis_resultado' analisis_obj.id %}" 
                                       class="btn btn-success btn-sm">
                                        <i class="fas fa-check-circle"></i> Ver An√°lisis
                                    </a>
                                {% elif analisis_obj.estado == 'en_proceso' %}
                                    <button class="btn btn-warning btn-sm" disabled>
                                        <i class="fas fa-spinner fa-spin"></i> Analizando...
                                    </button>
                                {% else %}
                                    <button class="analyze-btn btn btn-outline-danger btn-sm" 
                                            data-noticia-id="{{ noticia.id }}">
                                        <i class="fas fa-redo"></i> Reintentar
                                    </button>
                                {% endif %}
                            {% else %}
                                <!-- ‚ùå NO TIENE AN√ÅLISIS - BOT√ìN AMARILLO -->
                                {% if user.profile.role == 'premium' or user.is_staff %}
                                    <button class="analyze-btn btn btn-warning btn-sm" 
                                            data-noticia-id="{{ noticia.id }}">
                                        <i class="fas fa-chart-line"></i> Analizar Noticia
                                    </button>
                                {% else %}
                                    <button class="btn btn-secondary btn-sm" disabled>
                                        <i class="fas fa-crown"></i> Premium Requerido
                                    </button>
                                {% endif %}
                            {% endif %}
                        {% endwith %}
                        {% endwith %}
                    </div>
                    
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No hay noticias para mostrar con el filtro actual.
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'analisis/js/analisis.js' %}"></script>
{% endblock %}
{% block extra_css %}
<style>
    /* FORZAR COLORES DE BOTONES */
    .btn-success {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
        color: white !important;
    }
    .btn-warning {
        background-color: #ffc107 !important;
        border-color: #ffc107 !important;
        color: black !important;
    }
    .btn-danger {
        background-color: #dc3545 !important;
        border-color: #dc3545 !important;
        color: white !important;
    }
</style>
{% endblock %}